<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小组抽取概率模拟器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto py-8 px-4">
        <h1 class="text-3xl font-bold text-center mb-8">小组抽取概率模拟器</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">模拟设置</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">模拟次数</label>
                    <input type="number" id="simulationCount" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="1000" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">重置频率（每多少次抽取后重置权重）</label>
                    <input type="number" id="resetFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="0" min="0" placeholder="0表示不重置">
                </div>
            </div>
            
            <div class="flex justify-end mt-4">
                <button id="startSimulation" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    开始模拟
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">抽取结果统计</h2>
                <div id="resultsTable" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">小组</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">抽中次数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="resultsBody">
                            <!-- 结果将在此显示 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">抽取结果可视化</h2>
                <canvas id="resultsChart" width="400" height="300"></canvas>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mt-8">
            <h2 class="text-xl font-bold mb-4">模拟过程日志</h2>
            <div id="simulationLog" class="h-64 overflow-y-auto bg-gray-50 p-4 rounded-md font-mono text-sm">
                <!-- 日志将在此显示 -->
            </div>
        </div>
    </div>

    <script>
        // 模拟数据
        const groups = [
            { id: '1', name: '第一组' },
            { id: '2', name: '第二组' },
            { id: '3', name: '第三组' },
            { id: '4', name: '第四组' },
            { id: '5', name: '第五组' },
            { id: '6', name: '第六组' },
            { id: '7', name: '第七组' },
            { id: '8', name: '第八组' }
        ];
        
        // 权重系统
        let groupWeights = {};
        let resultsChart = null;
        
        // 初始化权重
        function initializeWeights() {
            groupWeights = {};
            groups.forEach(group => {
                groupWeights[group.id] = 100; // 初始权重为100
            });
            
            logMessage('权重已初始化，每个小组的初始权重为100');
        }
        
        // 根据权重抽取小组
        function drawGroupByWeight() {
            // 计算总权重
            let totalWeight = 0;
            groups.forEach(group => {
                totalWeight += (groupWeights[group.id] || 100);
            });
            
            // 根据权重随机选择
            let randomWeight = Math.random() * totalWeight;
            let cumulativeWeight = 0;
            let selectedGroup = null;
            
            for (let i = 0; i < groups.length; i++) {
                cumulativeWeight += (groupWeights[groups[i].id] || 100);
                if (randomWeight <= cumulativeWeight) {
                    selectedGroup = groups[i];
                    break;
                }
            }
            
            // 更新权重：被选中的重置为100，未选中的增加50%
            Object.keys(groupWeights).forEach(groupId => {
                if (groupId === selectedGroup.id) {
                    groupWeights[groupId] = 100; // 重置为基础权重
                } else {
                    groupWeights[groupId] = Math.round(groupWeights[groupId] * 1.5); // 增加50%
                }
            });
            
            return selectedGroup;
        }
        
        // 记录日志消息
        function logMessage(message) {
            const logElement = document.getElementById('simulationLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1';
            logEntry.textContent = message;
            logElement.appendChild(logEntry);
            
            // 自动滚动到最新消息
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 更新结果表格
        function updateResultsTable(counts, totalDraws) {
            const tableBody = document.getElementById('resultsBody');
            tableBody.innerHTML = '';
            
            const sortedGroups = [...groups].sort((a, b) => 
                (counts[b.id] || 0) - (counts[a.id] || 0)
            );
            
            sortedGroups.forEach(group => {
                const count = counts[group.id] || 0;
                const percentage = ((count / totalDraws) * 100).toFixed(2);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${group.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${count}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${percentage}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 更新结果图表
        function updateResultsChart(counts, totalDraws) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            
            const labels = groups.map(group => group.name);
            const data = groups.map(group => counts[group.id] || 0);
            const percentages = groups.map(group => 
                ((counts[group.id] || 0) / totalDraws * 100).toFixed(2)
            );
            
            if (resultsChart) {
                resultsChart.destroy();
            }
            
            resultsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '抽中次数',
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(199, 199, 199, 0.6)',
                            'rgba(83, 102, 255, 0.6)'
                        ],
                        borderColor: [
                            'rgb(255, 99, 132)',
                            'rgb(54, 162, 235)',
                            'rgb(255, 206, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(153, 102, 255)',
                            'rgb(255, 159, 64)',
                            'rgb(199, 199, 199)',
                            'rgb(83, 102, 255)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return `抽中次数: ${data[index]} (${percentages[index]}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 开始模拟
        document.getElementById('startSimulation').addEventListener('click', function() {
            const simulationCount = parseInt(document.getElementById('simulationCount').value) || 1000;
            const resetFrequency = parseInt(document.getElementById('resetFrequency').value) || 0;
            
            if (simulationCount <= 0) {
                alert('请输入有效的模拟次数');
                return;
            }
            
            // 清空日志
            document.getElementById('simulationLog').innerHTML = '';
            
            // 初始化权重和计数
            initializeWeights();
            const drawCounts = {};
            groups.forEach(group => {
                drawCounts[group.id] = 0;
            });
            
            logMessage(`开始模拟 ${simulationCount} 次抽取...`);
            
            // 执行模拟
            for (let i = 0; i < simulationCount; i++) {
                // 如果设置了重置频率并且到达重置点，重置权重
                if (resetFrequency > 0 && i > 0 && i % resetFrequency === 0) {
                    initializeWeights();
                    logMessage(`第 ${i} 次抽取：重置所有权重为初始值`);
                }
                
                const selectedGroup = drawGroupByWeight();
                drawCounts[selectedGroup.id] = (drawCounts[selectedGroup.id] || 0) + 1;
                
                // 只记录前10次和最后10次的详细日志，避免日志过多
                if (i < 10 || i >= simulationCount - 10) {
                    logMessage(`第 ${i + 1} 次抽取：${selectedGroup.name} 被选中`);
                    
                    // 记录每组的新权重
                    if (i < 5 || i >= simulationCount - 5) {
                        let weightsInfo = '当前权重: ';
                        groups.forEach(group => {
                            weightsInfo += `${group.name}: ${groupWeights[group.id]} | `;
                        });
                        logMessage(weightsInfo);
                    }
                } else if (i === 10) {
                    logMessage('...... 中间过程省略 ......');
                }
            }
            
            // 更新结果显示
            updateResultsTable(drawCounts, simulationCount);
            updateResultsChart(drawCounts, simulationCount);
            
            // 计算理论上的均匀分布情况
            const idealPercentage = (100 / groups.length).toFixed(2);
            logMessage(`模拟完成！理想情况下，每个小组应该有 ${idealPercentage}% 的概率被抽中。`);
            
            // 分析结果公平性
            const counts = groups.map(group => drawCounts[group.id] || 0);
            const average = counts.reduce((a, b) => a + b, 0) / counts.length;
            const deviations = counts.map(count => Math.abs(count - average) / average * 100);
            const maxDeviation = Math.max(...deviations).toFixed(2);
            const fairnessScore = 100 - (maxDeviation / 2);
            
            logMessage(`最大偏差率: ${maxDeviation}%`);
            logMessage(`公平性评分: ${fairnessScore.toFixed(2)}/100`);
        });
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', function() {
            initializeWeights();
            
            // 初始化空结果表格
            const counts = {};
            updateResultsTable(counts, 0);
            updateResultsChart(counts, 0);
        });
    </script>
</body>
</html> 